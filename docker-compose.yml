# Unified Docker Compose Configuration for Amiquin
# Supports two deployment profiles:
#
#   - dev: Development stack (bot + mysql + qdrant + web UI + ollama)
#   - prod: Production stack (bot + mysql + qdrant + ollama)
#
# Usage examples:
#   docker-compose --profile dev up -d
#   docker-compose --profile prod up -d

name: Amiquin

services:
  # MySQL Database Service
  mysql:
    profiles:
      - dev
      - prod
    container_name: amq-mysql
    image: mysql:${MYSQL_VERSION:-8.0}
    restart: unless-stopped
    env_file:
      - .env
    environment:
      MYSQL_ROOT_PASSWORD: ${AMQ_DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${AMQ_DB_NAME}
      MYSQL_USER: ${AMQ_DB_USER}
      MYSQL_PASSWORD: ${AMQ_DB_USER_PASSWORD}
    ports:
      - "${AMQ_MYSQL_PORT:-3306}:3306"
    volumes:
      - amq-db-data:/var/lib/mysql
      - ./mysql/conf.d:/etc/mysql/conf.d:ro
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - amiquin-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Qdrant Vector Database Service
  qdrant:
    profiles:
      - dev
      - prod
    container_name: amq-qdrant
    image: qdrant/qdrant:${QDRANT_VERSION:-latest}
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Basic configuration
      QDRANT__LOG_LEVEL: ${AMQ_QDRANT_LOG_LEVEL:-INFO}
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334

      # Production performance settings (only applied in production profiles)
      QDRANT__SERVICE__MAX_REQUEST_SIZE_MB: ${QDRANT_MAX_REQUEST_SIZE_MB:-64}
      QDRANT__SERVICE__MAX_WORKERS: ${QDRANT_MAX_WORKERS:-0}

      # Storage settings
      QDRANT__STORAGE__STORAGE_PATH: /qdrant/storage
      QDRANT__STORAGE__SNAPSHOTS_PATH: /qdrant/snapshots
      QDRANT__STORAGE__TEMP_PATH: /qdrant/temp

      # WAL settings for durability
      QDRANT__STORAGE__WAL__WAL_CAPACITY_MB: ${QDRANT_WAL_CAPACITY_MB:-32}
      QDRANT__STORAGE__WAL__WAL_SEGMENTS_AHEAD: ${QDRANT_WAL_SEGMENTS_AHEAD:-0}

      # Optimizer settings
      QDRANT__STORAGE__OPTIMIZERS__DEFAULT_SEGMENT_NUMBER: ${QDRANT_DEFAULT_SEGMENT_NUMBER:-0}
      QDRANT__STORAGE__OPTIMIZERS__MEMMAP_THRESHOLD_KB: ${QDRANT_MEMMAP_THRESHOLD_KB:-200000}
      QDRANT__STORAGE__OPTIMIZERS__INDEXING_THRESHOLD_KB: ${QDRANT_INDEXING_THRESHOLD_KB:-20000}

      # HNSW index settings
      QDRANT__STORAGE__HNSW__M: ${QDRANT_HNSW_M:-16}
      QDRANT__STORAGE__HNSW__EF_CONSTRUCT: ${QDRANT_HNSW_EF_CONSTRUCT:-100}
      QDRANT__STORAGE__HNSW__FULL_SCAN_THRESHOLD: ${QDRANT_HNSW_FULL_SCAN_THRESHOLD:-10000}

      # Security and telemetry
      QDRANT__SERVICE__ENABLE_CORS: ${QDRANT_ENABLE_CORS:-false}
      QDRANT__TELEMETRY_DISABLED: ${QDRANT_TELEMETRY_DISABLED:-true}
      QDRANT__SERVICE__TELEMETRY_DISABLED: ${QDRANT_TELEMETRY_DISABLED:-true}
    ports:
      - "${AMQ_QDRANT_HTTP_PORT:-6333}:6333" # REST API
      - "${AMQ_QDRANT_GRPC_PORT:-6334}:6334" # gRPC API
    volumes:
      - amq-qdrant-data:/qdrant/storage
      - amq-qdrant-snapshots:/qdrant/snapshots
      - amq-qdrant-temp:/qdrant/temp
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      memlock: -1
    healthcheck:
      test:
        ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - amiquin-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: ${QDRANT_MEMORY_LIMIT:-4G}
        reservations:
          memory: ${QDRANT_MEMORY_RESERVATION:-2G}

  # Qdrant Web UI (Development only)
  qdrant-web-ui:
    profiles:
      - dev
    container_name: amq-qdrant-ui
    image: qdrant/qdrant-web-ui:latest
    restart: unless-stopped
    ports:
      - "${AMQ_QDRANT_WEB_UI_PORT:-3000}:3000"
    environment:
      - QDRANT_URL=http://qdrant:6333
    depends_on:
      qdrant:
        condition: service_healthy
    networks:
      - amiquin-network

  # Ollama Local LLM Service (for local embeddings)
  ollama:
    profiles:
      - dev
      - prod
    container_name: amq-ollama
    image: ollama/ollama:${OLLAMA_VERSION:-latest}
    restart: unless-stopped
    ports:
      - "${AMQ_OLLAMA_PORT:-11434}:11434"
    volumes:
      - amq-ollama-data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_KEEP_ALIVE=${OLLAMA_KEEP_ALIVE:-5m}
      - OLLAMA_NUM_PARALLEL=${OLLAMA_NUM_PARALLEL:-1}
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - amiquin-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: ${OLLAMA_MEMORY_LIMIT:-4G}
        reservations:
          memory: ${OLLAMA_MEMORY_RESERVATION:-1G}

  # One-shot init container to ensure the embedding model is available in Ollama
  ollama-init:
    profiles:
      - dev
      - prod
    container_name: amq-ollama-init
    image: ollama/ollama:${OLLAMA_VERSION:-latest}
    restart: "no"
    depends_on:
      ollama:
        condition: service_healthy
    environment:
      - OLLAMA_HOST=http://ollama:11434
    entrypoint: ["/bin/sh", "-lc"]
    command: "ollama pull ${AMQ_Embedding__Ollama__Model:-nomic-embed-text}"
    networks:
      - amiquin-network

  # Amiquin Bot Service
  amiquinbot:
    profiles:
      - dev
      - prod
    container_name: amq-bot
    build:
      context: ./source
      dockerfile: Amiquin.Bot/dockerfile
      args:
        AMQ_BOT_NAME: ${AMQ_BOT_NAME:-amiquin}
        CONFIGURATION: ${BUILD_CONFIGURATION:-Release}
    env_file:
      - .env
    environment:
      # Container networking overrides (when using docker-compose services)
      AMQ_Memory__Qdrant__Host: qdrant
      AMQ_Embedding__Ollama__BaseUrl: "http://ollama:11434"

      # Default to local embeddings in containers (override in .env if needed)
      AMQ_Embedding__Provider: ${AMQ_Embedding__Provider:-ollama}
      # MySQL connection (only used when AMQ_Database__Mode=0)
      AMQ_Database__ConnectionString: "Server=mysql;Port=3306;Database=${AMQ_DB_NAME:-amiquin_db};Uid=${AMQ_DB_USER:-amiquin_user};Pwd=${AMQ_DB_USER_PASSWORD};SslMode=None;AllowPublicKeyRetrieval=True;Pooling=True;MinimumPoolSize=5;MaximumPoolSize=50;ConnectionTimeout=30;DefaultCommandTimeout=30;"

      # Production performance settings
      DOTNET_GCServer: ${DOTNET_GC_SERVER:-true}
      DOTNET_GCConcurrent: ${DOTNET_GC_CONCURRENT:-true}
      DOTNET_GCRetainVM: ${DOTNET_GC_RETAIN_VM:-true}
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Production}
    ports:
      - "${AMQ_BOT_PORT:-10001}:10000"
    volumes:
      # Persistent data volume (database, logs, sessions, plugins)
      - amq-data:/app/Data
    depends_on:
      mysql:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - amiquin-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    deploy:
      resources:
        limits:
          memory: ${AMIQUIN_MEMORY_LIMIT:-2G}
        reservations:
          memory: ${AMIQUIN_MEMORY_RESERVATION:-512M}
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'dotnet.*Amiquin.Bot.dll' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  # Amiquin bot persistent data (database, logs, sessions, plugins)
  amq-data:
    driver: local
  # MySQL database data
  amq-db-data:
    driver: local
  # Qdrant vector database storage
  amq-qdrant-data:
    driver: local
  amq-qdrant-snapshots:
    driver: local
  amq-qdrant-temp:
    driver: local
  # Ollama models storage
  amq-ollama-data:
    driver: local

networks:
  amiquin-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16
